# TestMe v0.8.31 Release Notes

Released: 2025-11-27

## Enhancements

### Windows Performance Optimizations

Comprehensive performance optimizations that dramatically improve test execution speed on Windows.

**Key Improvements:**

| Optimization | Impact |
|-------------|--------|
| C binary caching (mtime comparison) | 70-90% faster repeated runs |
| `--rebuild` / `-R` flag | Force recompilation when needed |
| Keep artifacts by default | Enables binary caching |
| Cache shell paths (Git Bash, PowerShell, Unix) | Eliminates subprocess spawns |
| Cache compiler detection | Eliminates repeated detection |
| Cache config file lookups | Eliminates directory walks |
| Replace `tasklist` with `process.kill(pid, 0)` | Zero-overhead process checks |
| Cache `findInPath` results | Eliminates where/which calls |
| Use `readdir({ withFileTypes: true })` | 50-70% fewer stat() calls |
| Reduce file deletion retry params | 13s â†’ 1.5s worst-case cleanup |

**New CLI Flag:**

```bash
tm -R                        # Force recompilation of C tests
tm --rebuild                 # Same as -R
```

**Technical Details:**

1. **C Binary Caching**: Compares source file mtime with compiled binary mtime. Skips compilation if binary is newer.
2. **Zero-overhead Process Checking**: `process.kill(pid, 0)` checks process existence without spawning subprocesses (works cross-platform).
3. **Module-level Caching**: Shell paths, compiler configs, and `findInPath` results cached in static Maps.
4. **Dirent-based Traversal**: `readdir({ withFileTypes: true })` returns file type info without separate stat() calls.

**Implementation Files:**

- [src/handlers/c.ts](src/handlers/c.ts) - Binary caching with `needsRecompilation()`
- [src/platform/process.ts](src/platform/process.ts) - Zero-overhead process checking
- [src/platform/shell.ts](src/platform/shell.ts) - Shell path caching
- [src/platform/compiler.ts](src/platform/compiler.ts) - Compiler detection caching
- [src/platform/detector.ts](src/platform/detector.ts) - findInPath caching
- [src/config.ts](src/config.ts) - Config file caching
- [src/discovery.ts](src/discovery.ts) - Dirent-based directory traversal
- [src/artifacts.ts](src/artifacts.ts) - Optimized cleanup with reduced retries

### Compiler Warning Display Option

Added `--warning` (`-w`) CLI flag to display compiler warnings and the compile command line for C tests with minimal output.

**Features:**

- Shows compiler name and type (e.g., `/usr/bin/gcc (gcc)`)
- Shows full compile command line with all flags and libraries
- Shows compiler warnings (stderr) from successful compilations
- Provides focused output without full configuration dump

**Usage Examples:**

```bash
tm -w test.tst.c             # Show compile command + warnings (minimal)
tm -w "*.tst.c"              # Show for all C tests
tm -w -v test.tst.c          # Combine with verbose for full output
```

**Output Format:**

```
ðŸ”§ Compiler: /usr/bin/gcc (gcc)
ðŸ“‹ Compile command: /usr/bin/gcc -Wall -Wextra -o .testme/test/test test.tst.c
```

**Comparison with `-s` (show):**

| Flag | Config | Compile Command | Environment | Warnings |
|------|--------|-----------------|-------------|----------|
| `-w` | No | Yes | No | Yes |
| `-s` | Yes | Yes | Yes | No |
| `-s -v` | Yes | Yes | Yes | Yes |

**Implementation:**

- CLI flag parsing in [src/cli.ts:143-147](src/cli.ts#L143-L147)
- Type definition `warning` in [src/types.ts:244](src/types.ts#L244)
- Type definition `showWarnings` in [src/types.ts:127](src/types.ts#L127)
- Config application in [src/index.ts:766-774](src/index.ts#L766-L774)
- Handler logic in [src/handlers/c.ts:255-294](src/handlers/c.ts#L255-L294)

**Use Cases:**

- Quickly identify compiler warnings without verbose output
- Debug compilation issues by seeing exact command line
- CI/CD pipelines that need to capture warnings
- Development workflow for cleaning up warnings

## Breaking Changes

### Workers Flag Changed to -W

The short flag for `--workers` has changed from `-w` to `-W` (capital) to accommodate the new `--warning` flag.

**Migration:**

```bash
# Before (v0.8.30 and earlier)
tm -w 8 "*.tst.c"            # 8 parallel workers

# After (v0.8.31+)
tm -W 8 "*.tst.c"            # 8 parallel workers (capital W)
```

**Rationale:**

- `-w` is commonly associated with warnings in compiler tools (e.g., `gcc -w`)
- Capital `-W` is still mnemonic for "Workers"
- The `--workers` long form remains unchanged

## Bug Fixes

### HTTP Health Check Socket Leak

Fixed potential socket leak in HTTP health checks by adding `Connection: close` header to fetch requests.

**Root Cause:**

HTTP health check requests were not explicitly requesting connection closure, which could lead to TCP sockets remaining open between polling intervals during service startup.

**Fix:**

Added `Connection: close` header to ensure sockets are closed after each health check:

```typescript
const response = await fetch(config.url, {
    method: 'GET',
    headers: {
        Connection: 'close',
    },
    signal: AbortSignal.timeout(5000),
})
```

**Implementation:**

- Header addition in [src/services/health-check.ts:118-120](src/services/health-check.ts#L118-L120)

**Impact:** Improved reliability of health checks during service startup, especially for long-running polling scenarios.

### Platform-Specific Exclude Patterns on Windows

Fixed platform-specific exclude patterns in subdirectory testme.json5 configs not working on Windows.

**Issue:** Exclude patterns like `windows: { exclude: ['**/unix.tst.sh'] }` in subdirectory configs were not filtering out tests on Windows.

**Root Cause:** Two issues:

1. `matchesExcludePatterns()` passed raw file paths (with Windows `\` separators) to glob matcher, while patterns use `/`
2. Initial test discovery used root config patterns only; subdirectory config patterns were not applied during grouping

**Fix:**

1. Updated `matchesExcludePatterns()` to normalize paths (convert `\` to `/`) before matching
2. Made `matchesExcludePatterns()` public for use during test grouping
3. Updated `groupTestsByConfig()` to apply each config's exclude patterns when grouping tests

**Implementation:**

- Path normalization in [src/discovery.ts:199-210](src/discovery.ts#L199-L210)
- Config exclude filtering in [src/index.ts:678-683](src/index.ts#L678-L683)

**Impact:** Subdirectory testme.json5 configs now properly apply platform-specific exclude patterns. Tests excluded by config patterns (e.g., Unix-only tests on Windows) are filtered out during grouping without requiring a root-level config.

## Upgrade Notes

**Breaking Change:** The `-w` short flag now means `--warning` instead of `--workers`. Update any scripts or CI configurations that use `-w` for workers to use `-W` instead.

```bash
# Update CI scripts
- tm -w 4                    # Old: workers
+ tm -W 4                    # New: workers

# New warning option
tm -w test.tst.c             # Show compile warnings
```

## Previous Release

See [v0.8.30 Release Notes](v0.8.30.md) for the previous release.
