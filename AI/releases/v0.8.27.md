# TestMe v0.8.27 Release Notes

Released: October 31, 2025

## Enhancements

### Health Check Robustness

**Setup Process Exit Detection:**
- Health checks now monitor the setup process and stop immediately if it exits
- Prevents waiting for health check timeout when setup process fails early
- Provides clearer error messages: "Setup process exited with code X during health check"
- Non-blocking check polls every 10ms to detect process exit without blocking health checks
- Improves feedback loop for broken service configurations

### Test Error Reporting

**Improved Stack Trace Capture:**
- Enhanced `getStack()` function in JavaScript test module to better identify actual test code
- Now uses a "best candidate" approach when filtering internal test framework functions
- Handles edge cases where helper functions throw errors by reporting the next frame up
- More accurate file and line number reporting for test failures
- Better handling of complex stack traces with multiple framework layers

**Global Installation Path Handling:**
- Fixed stack trace detection when TestMe is installed globally via npm/bun
- Now correctly identifies test file locations on Windows, macOS, and Linux
- Handles various installation paths: node_modules/@embedthis/testme, .bun/install/global, etc.
- Added fallback logic in test() error handler to extract location from error stack when primary detection fails
- Eliminates "unknown file:unknown line" errors in globally-installed TestMe

## Implementation Details

### Health Check Changes

Modified `HealthCheckManager.waitForHealthy()` to accept optional `setupProcess` parameter:
- Checks if setup process has exited before each health check attempt
- Uses `Promise.race()` with 10ms timeout for non-blocking exit detection
- Throws descriptive error if process exits during health checks
- Backward compatible - setupProcess parameter is optional

### Stack Trace Changes

Improved `getStack()` logic in `src/modules/js/index.js`:
- Iterates through stack frames and tracks first valid candidate
- Continues searching for non-helper function frames
- Returns best candidate if all remaining frames are helper functions
- Falls back to "unknown file/line" only if no candidates found

## Files Changed

- [package.json](../../package.json) - Version bump to 0.8.27
- [src/version.ts](../../src/version.ts) - Version bump to 0.8.27
- [src/services.ts](../../src/services.ts) - Pass setup process to health check manager
- [src/services/health-check.ts](../../src/services/health-check.ts) - Add setup process monitoring
- [src/modules/js/index.js](../../src/modules/js/index.js) - Improve stack trace capture logic

## Upgrade Notes

This is an enhancement release that improves error handling and diagnostics. The changes are fully backward compatible and require no configuration updates.

Users upgrading from v0.8.26 will experience:
- Faster failure detection when setup services crash during health checks
- More accurate error location reporting in JavaScript/TypeScript tests
- Better error messages when services fail to start
- No changes to test execution behavior or configuration format

## Previous Release

See [v0.8.26 Release Notes](v0.8.26.md) for information about the previous release which included:
- Packaging and installation cleanup
- Removed vendored ejscript module linking
- Added JavaScript module package.json to npm manifest
