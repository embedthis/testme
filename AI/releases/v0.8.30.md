# TestMe v0.8.30 Release Notes

Released: TBD

## Enhancements

### Timeout CLI Override

Added `--timeout <SECONDS>` (`-t`) CLI flag to override the configured test timeout for a test run. This allows setting a custom timeout without modifying configuration files.

**Features:**

- Overrides `execution.timeout` from testme.json5
- Accepts timeout value in seconds
- Must be a positive integer
- Applies to all tests in the run
- Can be combined with other options like `--verbose`, `--workers`, etc.

**Usage Examples:**

```bash
tm --timeout 60 "long-test"         # 60 second timeout for specific test
tm -t 120 "*.tst.c"                 # 2 minute timeout for all C tests
tm --timeout 300                    # 5 minute timeout for all tests
```

**Implementation:**

- CLI flag parsing in [src/cli.ts:213-225](src/cli.ts#L213-L225)
- Configuration override in [src/index.ts:740-746](src/index.ts#L740-L746)
- Type definition in [src/types.ts:254](src/types.ts#L254)
- Documentation updates in man page and CLI help

**Use Cases:**

- Override timeout for specific test runs without changing config
- Use longer timeouts for debugging or slow CI/CD environments
- Use shorter timeouts for quick feedback during development

### Manual Enable Directory Detection

Enhanced `enable: "manual"` configuration to automatically run manual tests when `tm` is invoked from within the manual directory or its subdirectories without patterns.

**Previous Behavior:**

Tests with `enable: "manual"` only ran when explicitly named by pattern (e.g., `tm testname`).

**New Behavior:**

Tests with `enable: "manual"` now run in two scenarios:

1. When explicitly named: `tm testname` (existing behavior)
2. When `tm` is invoked from within the manual directory without patterns: `cd manual_test_dir && tm`

**Features:**

- Detects if current working directory is within or equal to the config directory
- Treats invocation from manual directory as an explicit manual request
- Applies to both test execution and `--list` command
- Does not affect pattern-based invocations from parent directories
- Provides clearer verbose output: "✓ Running manual tests in: . (invoked from manual directory)"

**Usage Examples:**

```bash
# Directory structure:
# /project/test/manual/testme.json5 (enable: "manual")
# /project/test/manual/slow.tst.c

# From parent directory - skips manual tests
cd /project/test
tm                                   # Skips manual tests (not invoked from manual dir)
tm "*.tst.c"                         # Skips manual tests (wildcard pattern)

# From manual directory - runs manual tests
cd /project/test/manual
tm                                   # Runs manual tests (invoked from manual dir)
tm --list                            # Lists manual tests (invoked from manual dir)

# From subdirectory of manual directory - runs manual tests
cd /project/test/manual/subdir
tm                                   # Runs manual tests in parent (invoked from within manual tree)

# Explicit naming - always works
cd /project/test
tm slow                              # Runs manual test (explicitly named)
tm manual/slow.tst.c                 # Runs manual test (explicitly named)
```

**Implementation:**

- Test execution logic in [src/index.ts:468-510](src/index.ts#L468-L510)
- List command logic in [src/runner.ts:348-390](src/runner.ts#L348-L390)
- Path separator import in [src/index.ts:11](src/index.ts#L11)
- Documentation updates in man page

**Use Cases:**

- Developers working on manual tests can simply run `tm` in the test directory
- No need to remember test names or use patterns when in the manual directory
- Maintains protection from accidental execution when running from parent directories
- Useful for slow tests, destructive tests, or tests requiring special setup

### Duration Flag for Test Control

Added `--duration <COUNT>` CLI flag to set a duration value that is exported to tests and service scripts via the `TESTME_DURATION` environment variable. This is useful for tests that need to run for a specific duration, such as load tests that scale based on time, performance tests with configurable run times, and integration tests with timeout-based scenarios.

**Features:**

-   Supports multiple time unit suffixes:
    -   No suffix or `sec`/`secs` - Seconds (e.g., `--duration 30`)
    -   `min`/`mins` - Minutes (e.g., `--duration 5mins` → 300 seconds)
    -   `hr`/`hrs`/`hour`/`hours` - Hours (e.g., `--duration 2hrs` → 7200 seconds)
    -   `day`/`days` - Days (e.g., `--duration 3days` → 259200 seconds)
-   Supports decimal values (e.g., `--duration 1.5hours` → 5400 seconds)
-   Duration is always converted to seconds and exported as `TESTME_DURATION`
-   Available in all test types (C, Shell, JavaScript, TypeScript, Python, Go, Ejscript)
-   Available in all service scripts (skip, environment, prep, setup, cleanup)

**Usage Examples:**

```bash
tm --duration 30 "stress-test"          # 30 seconds
tm --duration 5mins "integration-test"  # 5 minutes = 300 seconds
tm --duration 2hrs "soak-test"          # 2 hours = 7200 seconds
tm --duration 1day "endurance-test"     # 1 day = 86400 seconds
```

**Implementation:**

-   CLI flag parsing in `src/cli.ts` with `parseDuration()` helper
-   Environment variable export in `src/handlers/base.ts` and `src/services.ts`
-   Configuration type updates in `src/types.ts`
-   Documentation updates in man page, README, and CLI help

**Use Cases:**

-   Tests that need to run for a specific duration
-   Load tests that scale based on time
-   Performance tests with configurable run times
-   Integration tests with timeout-based scenarios

## Bug Fixes

### Monitor Mode Not Streaming Output in Real-Time

Fixed `--monitor` (`-m`) flag not streaming test output in real-time during test execution. Output now appears progressively as tests run instead of only after completion.

**Root Causes:**

1. **C Tests:** The `testme.h` header functions (`tinfo`, `tdebug`, `tskip`, `twrite`, `tReport`) were not flushing stdout/stderr after printf calls, causing buffered output when stdout was piped to the test runner.

2. **TTY Check:** The `base.ts` handler was enforcing a strict TTY check (`process.stdout.isTTY === true`), preventing streaming when user explicitly requested `--monitor` but output was piped.

**Fixes:**

-   Added `fflush(stdout)` and `fflush(stderr)` after all printf/fprintf calls in C test utility functions
-   Removed strict TTY requirement - when user explicitly requests `--monitor`, honor it regardless of TTY status
-   Added description parameter to `runCommand` calls for better timeout error messages

**Impact:** Long-running tests (like memory leak detection) now show progress in real-time when using `--monitor` flag.

### Go Tests Skipped on Windows

Added platform detection to skip Go tests on Windows. Go tests are now automatically skipped on Windows platforms where the Go toolchain may not be available or compatible.

**Change:** Updated `test/go/skip.js` to detect Windows platform (`process.platform === 'win32'`) and skip tests before checking for Go installation.

**Impact:** Tests no longer fail on Windows CI/CD pipelines due to missing Go support.

### Manual Test Filtering with Same-Name Tests

Fixed manual test filtering to prevent running manual tests when using base name patterns from outside the manual directory. When a pattern like `tm tls` was used from a parent directory, it would incorrectly match and run tests with the same base name in subdirectories marked with `enable: 'manual'`, even though they should only run when explicitly targeted with the directory path.

**Previous Behavior:**

```bash
# Directory structure:
# /project/test/tls.tst.c
# /project/test/fuzz/testme.json5 (enable: "manual")
# /project/test/fuzz/tls.tst.c

cd /project/test
tm tls                    # Would run BOTH tls.tst.c AND fuzz/tls.tst.c (incorrect)
```

**Fixed Behavior:**

```bash
cd /project/test
tm tls                    # Runs only tls.tst.c (skips fuzz/tls.tst.c)
tm fuzz/tls               # Runs fuzz/tls.tst.c (explicit directory path)
tm --list tls             # Lists only tls.tst.c
tm --list fuzz/tls        # Lists fuzz/tls.tst.c

cd /project/test/fuzz
tm tls                    # Runs fuzz/tls.tst.c (invoked from manual directory)
```

**Implementation:**

- Added directory path check for manual tests in [src/index.ts:492-513](src/index.ts#L492-L513)
- When `enable: 'manual'` and not invoked from manual directory, patterns must explicitly include the directory path
- Added path-without-test-extension matching in [src/index.ts:360-369](src/index.ts#L360-L369)
- Applied same fix to `--list` command in [src/runner.ts:369-403](src/runner.ts#L369-L403)

**Test Coverage:**

- Added comprehensive test in [test/config/manual-filtering.tst.ts:100-138](test/config/manual-filtering.tst.ts#L100-L138)
- Tests verify that base name patterns don't match manual tests from outside directories
- Tests verify that directory-prefixed patterns do match manual tests

**Impact:** Manual tests are now properly isolated and only run when explicitly intended, preventing accidental execution of tests with common names in manual directories.

### Global Prep/Cleanup Output Not Shown in Verbose Mode

Fixed global prep and global cleanup scripts not emitting stdout/stderr output when running with the `--verbose` (`-v`) flag. Previously, regular prep/cleanup scripts would show their output in verbose mode, but global prep/cleanup scripts would not.

**Root Cause:**

The `globalPrep` and `globalCleanup` services were using the raw `rootConfig` without applying CLI overrides (such as `--verbose`), while regular prep/cleanup scripts used `mergedConfig` which had CLI overrides applied.

**Fix:**

Applied CLI overrides to `rootConfig` before passing it to `runGlobalPrep()` and `runGlobalCleanup()` methods. This ensures verbose mode works consistently for all service scripts.

**Implementation:**

- Global prep fix in [src/index.ts:451-453](src/index.ts#L451-L453)
- Global cleanup fix in [src/index.ts:639-645](src/index.ts#L639-L645)

**Behavior:**

```bash
# Without verbose mode - only shows completion messages
tm
# Output: ✓ Global prep completed successfully: prep.sh

# With verbose mode - shows script output
tm -v
# Output:
# Running global prep: prep.sh
# Global prep: Building shared libraries...
# Global prep: Done
# ✓ Global prep completed successfully: prep.sh
```

**Impact:** Developers can now see debug output from global prep/cleanup scripts when troubleshooting test setup issues.

### Global Prep Not Running on Windows

Fixed global prep scripts not running on Windows when specific test patterns were provided (e.g., `tm test/web/tls`). The issue was caused by incorrect path depth calculation in the `findRootConfig()` method.

**Root Cause:**

The `findRootConfig()` function calculated directory depth by splitting paths on forward slashes (`/`) only. On Windows, paths use backslashes (`\`), so a path like `D:\a\agent\agent\test\web` would be treated as a single segment instead of 6 segments, resulting in incorrect depth values. This prevented the shallowest config from being properly identified.

**Example of the Bug:**

```bash
# Windows CI/CD environment
cd D:\a\agent\agent
tm test/web/tls

# Expected: Global prep from D:\a\agent\agent\testme.json5 should run
# Actual: Global prep not detected due to incorrect depth calculation
```

**Fix:**

Normalized Windows backslashes to forward slashes before calculating path depth:

```typescript
// Before (broken on Windows)
const depth = currentDir.split('/').filter((s) => s).length

// After (works on all platforms)
const depth = currentDir.replace(/\\/g, '/').split('/').filter((s) => s).length
```

**Implementation:**

- Path depth calculation fix in [src/config.ts:232-233](src/config.ts#L232-L233)

**Impact:** Global prep scripts now run correctly on Windows CI/CD pipelines and local Windows development environments.

### Manual Test Filtering on Windows with Path Separators

Fixed manual test filtering on Windows when using directory-prefixed patterns. When running `tm manual-dir/test` on Windows, the test would be discovered but then incorrectly filtered out due to a path separator mismatch.

**Root Cause:**

The manual test filtering logic used a hardcoded forward slash (`/`) when removing the root directory prefix from config directory paths: `configDir.replace(rootDir + '/', '')`. On Windows, paths use backslashes, so the replacement failed and the relative path calculation was incorrect.

**Example of the Bug:**

```bash
# Windows environment with path: D:\test\manual-subdir
cd D:\test
tm manual-subdir/same-name

# Expected: Run the manual test in manual-subdir
# Actual: Test discovered but filtered out (Total: 0) due to path mismatch
```

**Fix:**

Changed to use platform-specific path separator (`sep` from Node.js `path` module):

```typescript
// Before (broken on Windows)
configDir.replace(rootDir + '/', '')

// After (works on all platforms)
configDir.replace(rootDir + sep, '')
```

**Implementation:**

- Path separator fix in [src/index.ts:510](src/index.ts#L510)

**Impact:** Manual tests now correctly run on Windows when explicitly named with directory paths.

### Unused Function Warnings in testme.h

Fixed compiler warnings about unused static functions when including `testme.h` in C test files. The `tReport()` and `texit()` helper functions would generate `-Wunused-function` warnings when not all test macros were used in a translation unit.

**Root Cause:**

Static functions defined in header files generate compiler warnings when included but not used by all code paths in a test file.

**Fix:**

Added `TM_UNUSED` macro using `__attribute__((unused))` for GCC/Clang to suppress warnings:

```c
// Portable unused attribute macro
#if defined(__GNUC__) || defined(__clang__)
    #define TM_UNUSED __attribute__((unused))
#else
    #define TM_UNUSED
#endif

// Applied to helper functions
TM_UNUSED static void tReport(int success, const char *loc, ...)
TM_UNUSED static void texit(int success)
```

**Implementation:**

- Added `TM_UNUSED` macro in [src/modules/c/testme.h:51-56](src/modules/c/testme.h#L51-L56)
- Applied attribute to `tReport()` in [src/modules/c/testme.h:144](src/modules/c/testme.h#L144)
- Applied attribute to `texit()` in [src/modules/c/testme.h:78](src/modules/c/testme.h#L78)

**Impact:** C tests now compile cleanly with `-Wall -Wextra` without spurious unused function warnings.

## Upgrade Notes

No breaking changes in this release. The manual enable enhancement is backward compatible - existing behavior with explicit patterns is preserved, with the addition of directory-based detection.

## Previous Release

See [v0.8.29 Release Notes](v0.8.29.md) for the previous release.
